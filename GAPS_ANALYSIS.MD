# An√°lisis de Gaps - Libros SAS

**Fecha de an√°lisis:** 2025-11-19
**Documentos revisados:** REQUERIMIENTOS.MD, CLAUDE.MD

---

## Resumen Ejecutivo

Se identificaron gaps entre los requerimientos funcionales y la documentaci√≥n t√©cnica. Este documento detalla cada gap para su revisi√≥n y priorizaci√≥n.

---

## 1. Gaps Cr√≠ticos (Bloqueantes para MVP)

### GAP-001: Proveedor de IA no definido

**Estado:** ‚úÖ RESUELTO

**Decisi√≥n tomada:**
- **Proveedor:** OpenRouter (Vercel AI SDK)
- **Ventajas:**
  - Flexibilidad para cambiar entre modelos (GPT-4, Claude, Llama)
  - Fallback autom√°tico si un modelo est√° ca√≠do
  - F√°cil comparaci√≥n de costos
- **Modelos por caso de uso:** A definir en variables de entorno
- **Fallback:** Procesamiento manual cuando IA no est√° disponible

**Documentado en:** CLAUDE.MD - Secci√≥n "AI Integration Strategy"

---

### GAP-002: Estrategia de almacenamiento de PDFs

**Estado:** ‚úÖ RESUELTO

**Decisi√≥n tomada:**
- **Almacenamiento:** Volumen local persistente `/data/files/`
- **Estructura:** `/data/files/{sociedad_id}/{libro_id}/{acto_id}/`
- **Migraci√≥n futura:** S3/MinIO cuando se necesite escalar
- **L√≠mites:** 50MB por archivo, 100 archivos por batch

**Documentado en:** CLAUDE.MD - Secci√≥n "File Storage Strategy"

---

### GAP-003: Procesamiento as√≠ncrono de PDFs

**Estado:** üü° PENDIENTE DECISI√ìN

**Opciones evaluadas:**

| Opci√≥n | Pros | Contras |
|--------|------|---------|
| **BullMQ + Redis** | Maduro, dashboard UI, reintentos, prioridades | Requiere Redis (m√°s infra/costo) |
| **Custom con SQLite** | Sin dependencias extra, simple para MVP | Hay que implementar, sin dashboard |

**Recomendaci√≥n:** Para MVP usar custom con SQLite (tabla `job_queue`). Migrar a BullMQ cuando escale.

**Decisi√≥n requerida:** ¬øCustom SQLite para MVP o BullMQ desde el inicio?

---

## 2. Gaps Importantes (Impactan funcionalidad core)

### GAP-011: Procesamiento de PDFs escaneados (OCR/Vision)

**Impacto:** Medio-Alto
**Requerimientos afectados:** FR-06, FR-08, FR-42

**Descripci√≥n:**
Muchos PDFs societarios son escaneados (sin texto seleccionable) y requieren OCR o Vision API para extraer contenido.

**Decisi√≥n tomada:**
- **Pipeline definido:**
  1. Detectar si PDF tiene texto seleccionable
  2. Si tiene texto ‚Üí usar pdf-parse
  3. Si no tiene/mala calidad ‚Üí convertir a im√°genes ‚Üí Vision API
- **Vision APIs** (v√≠a OpenRouter):
  - GPT-4 Vision para documentos complejos
  - Claude 3 Vision como alternativa
  - Gemini Pro Vision para optimizar costos
- **Fallback:** Tesseract.js para OCR offline como opci√≥n econ√≥mica

**Documentado en:** CLAUDE.MD - Secci√≥n "PDF Processing Strategy"

**Pendiente:** Definir umbrales de calidad de texto para decidir cu√°ndo usar Vision.

---

### GAP-004: Generaci√≥n de PDFs con encabezado de hash

**Impacto:** Medio-Alto
**Requerimientos afectados:** FR-20, FR-24

**Descripci√≥n:**
Se debe generar PDFs con encabezado que incluya hash anterior, pero no se defini√≥:
- Librer√≠a de generaci√≥n de PDF (puppeteer, pdf-lib, jsPDF)
- Template del encabezado
- C√≥mo insertar encabezado en PDFs existentes (IVA)

**Decisiones requeridas:**
1. ¬øQu√© librer√≠a usar para generar PDFs?
2. ¬øC√≥mo insertar p√°gina de encabezado en PDF existente?
3. ¬øFormato exacto del encabezado?

**Recomendaci√≥n:**
Usar `pdf-lib` para manipulaci√≥n de PDFs existentes y React-PDF o Puppeteer para generar nuevos.

---

### GAP-005: Modelo de Contexto y versionado

**Estado:** üü° PENDIENTE DECISI√ìN

**Opciones evaluadas:**

| Opci√≥n | Pros | Contras |
|--------|------|---------|
| **Markdown** | Familiar, f√°cil renderizar, IA lo genera bien, versionable | Menos control estructura |
| **JSON estructurado** | Validaci√≥n schema, consultas granulares | Necesita UI custom, menos flexible |

**Recomendaci√≥n:** Markdown - Balance entre flexibilidad y estructura. Usar `diff` o `jsdiff` para comparar versiones.

**Decisi√≥n requerida:** ¬øMarkdown o JSON estructurado?

---

### GAP-006: Extracci√≥n de hash del comprobante TAD

**Estado:** ‚úÖ RESUELTO

**An√°lisis del comprobante real (IF-2023-05069991-APN-DA#IGJ):**

El comprobante TAD es un PDF generado por la IGJ con:
- **Formato:** PDF con texto seleccionable (NO requiere OCR)
- **Hash:** En l√≠nea `Hash: a53ab3dade11bd9036938f1ba67158210e723f9027759ee639e2d853fb022545`
- **Metadatos incluidos:**
  - Tipo de libro
  - Tipo de acta
  - Fecha del acta
  - N¬∞ acta
- **Firma digital:** "Gestion Documental Electronica" con timestamp

**Implementaci√≥n:**
- Usar `pdf-parse` para extraer texto
- Regex: `/Hash:\s*([a-f0-9]{64})/i` para obtener el hash
- Fallback: Input manual si la extracci√≥n falla
- Validar que los metadatos coincidan con el acto

**Documentado en:** Ejemplo en `/Libro de actas - Socios 2022-11-24 - 5 - Hash*.pdf`

---

### GAP-007: Sistema de templates estructurado

**Estado:** üü° PENDIENTE DECISI√ìN

**Opciones evaluadas:**

| Opci√≥n | Pros | Contras |
|--------|------|---------|
| **Handlebars** | Condicionales `{{#if}}`, loops `{{#each}}`, helpers custom | M√°s complejo, ~50KB |
| **Mustache** | Muy simple, peque√±o (~10KB), logic-less | Sin condicionales complejos |
| **Custom** | Sin dependencias, control total | Hay que implementar todo |

**Ejemplo de uso:**
```handlebars
En {{ciudad}}, a los {{dia}} d√≠as de {{mes}} de {{a√±o}}...
{{#if multiples_socios}}
Los socios presentes son:
{{#each socios}}
- {{nombre}} (DNI {{dni}})
{{/each}}
{{else}}
Con la presencia del √∫nico socio {{socio_unico.nombre}}...
{{/if}}
```

**Recomendaci√≥n:** Handlebars - Los templates de actas necesitan condicionales y loops. Guardar referencia a versi√≥n de template en cada acto.

**Decisi√≥n requerida:** ¬øHandlebars, Mustache, o custom?

---

## 3. Gaps Menores (Mejoras de UX/DX)

### GAP-008: Flujo de invitaci√≥n de usuarios

**Impacto:** Bajo
**Requerimientos afectados:** FR-02

**Descripci√≥n:**
El Owner puede invitar usuarios, pero no se defini√≥:
- Email de invitaci√≥n (contenido, branding)
- Flujo si el usuario ya tiene cuenta vs no tiene
- Expiraci√≥n de invitaci√≥n

**Recomendaci√≥n:**
Definir en fase de dise√±o de UI. No bloqueante para backend.

---

### GAP-009: Formato de exportaci√≥n

**Impacto:** Bajo
**Requerimientos afectados:** FR-46

**Descripci√≥n:**
Se puede exportar datos, pero no se defini√≥ formato exacto de:
- Metadatos en JSON/CSV
- Estructura del ZIP de backup
- PDF compilado (portada, √≠ndice, separadores)

**Recomendaci√≥n:**
Definir durante implementaci√≥n. Empezar simple y mejorar.

---

### GAP-010: Nivel de detalle de auditor√≠a

**Impacto:** Bajo
**Requerimientos afectados:** FR-31

**Descripci√≥n:**
Se debe registrar auditor√≠a, pero no se defini√≥:
- Qu√© campos exactos guardar para cada acci√≥n
- Formato de "descripci√≥n legible del cambio"
- Retenci√≥n de logs

**Recomendaci√≥n:**
Definir estructura base e ir expandiendo seg√∫n necesidad.

---

## 4. Inconsistencias Detectadas

### INC-001: Nomenclatura de roles

**Documentos afectados:** REQUERIMIENTOS.MD, CLAUDE.MD

**Inconsistencia:**
- REQUERIMIENTOS.MD: Superadmin, Owner, RW, RO, Contador
- CLAUDE.MD (anterior): SuperAdmin, Institution Admin, Regular User

**Estado:** ‚úÖ RESUELTO - CLAUDE.MD actualizado

---

### INC-002: Modelo "Books" vs "Libro"

**Documentos afectados:** CLAUDE.MD

**Inconsistencia:**
CLAUDE.MD original usaba "Books" (ingl√©s), pero REQUERIMIENTOS.MD usa "Libro" (espa√±ol).

**Estado:** ‚úÖ RESUELTO - CLAUDE.MD actualizado a "Libro"

---

### INC-003: Sistema de notificaciones mencionado pero no requerido

**Documentos afectados:** REQUERIMIENTOS.MD (original), CLAUDE.MD

**Inconsistencia:**
CLAUDE.MD mencionaba "Notification System" pero REQUERIMIENTOS.MD original no ten√≠a requerimientos de notificaciones.

**Estado:** ‚úÖ RESUELTO - FR-44 agregado a REQUERIMIENTOS.MD

---

## 5. Preguntas Abiertas - RESPONDIDAS

### Q-001: Integraci√≥n futura con TAD
**Respuesta:** No se sabe si TAD tiene API. Por ahora, flujo manual (copiar hash, subir comprobante).

**Impacto:** No afecta dise√±o actual. Si existe API en el futuro, se puede agregar como feature.

---

### Q-002: Multi-tenancy
**Respuesta:** S√≠, un usuario puede ver m√°s de una sociedad.

**Impacto:** Ya contemplado en el dise√±o con `UsuarioXSociedad`. El JWT incluye lista de sociedades con permisos.

---

### Q-003: Soporte offline
**Respuesta:** Sin soporte offline.

**Impacto:** Simplifica arquitectura. No se necesita service worker ni sincronizaci√≥n.

---

### Q-004: Firma digital
**Respuesta:** Si se necesita firma digital, se gestiona afuera del sistema.

**Impacto:** El sistema solo maneja PDFs ya firmados. No se necesita integraci√≥n con proveedores de firma.

---

### Q-005: Retenci√≥n legal
**Respuesta:**
- Documentos finales solo se borran l√≥gicamente
- Plazo legal: 10 a√±os
- Es responsabilidad del usuario mantener la suscripci√≥n
- Si deja de pagar, se pueden eliminar f√≠sicamente

**Impacto:**
- Implementar soft delete para todo
- Agregar pol√≠tica de retenci√≥n configurable
- Job de limpieza para cuentas inactivas (futuro)

---

### Q-006: Auditor√≠as externas
**Respuesta:** S√≠, ser√≠a bueno tener log de eventos y versiones anteriores.

**Impacto:** Ya contemplado con:
- AuditLog para eventos
- Versionado de Contexto y metadatos
- Los auditores pueden ser usuarios RO de la sociedad

---

## 6. Matriz de Priorizaci√≥n

| Gap ID | Descripci√≥n | Impacto | Esfuerzo | Prioridad | Estado |
|--------|-------------|---------|----------|-----------|--------|
| GAP-001 | Proveedor de IA | Alto | Bajo | **P0** | ‚úÖ Resuelto |
| GAP-002 | Almacenamiento PDFs | Alto | Medio | **P0** | ‚úÖ Resuelto |
| GAP-003 | Procesamiento as√≠ncrono | Alto | Alto | **P1** | üü° Pendiente decisi√≥n |
| GAP-011 | OCR/Vision para PDFs | Medio-Alto | Medio | **P1** | ‚úÖ Resuelto |
| GAP-004 | Generaci√≥n de PDFs | Medio-Alto | Medio | **P1** | Pendiente |
| GAP-005 | Modelo de Contexto | Medio | Medio | **P2** | üü° Pendiente decisi√≥n |
| GAP-006 | Extracci√≥n hash TAD | Medio | Bajo | **P2** | ‚úÖ Resuelto |
| GAP-007 | Sistema de templates | Medio | Medio | **P2** | üü° Pendiente decisi√≥n |
| GAP-008 | Invitaci√≥n usuarios | Bajo | Bajo | **P3** | Pendiente |
| GAP-009 | Formato exportaci√≥n | Bajo | Bajo | **P3** | Pendiente |
| GAP-010 | Detalle auditor√≠a | Bajo | Bajo | **P3** | Pendiente |

---

## 7. Pr√≥ximos Pasos Recomendados

1. **Completado:**
   - [x] Decidir proveedor de IA (GAP-001) ‚Üí **OpenRouter**
   - [x] Definir estrategia de procesamiento PDFs (GAP-011) ‚Üí **Vision API fallback**
   - [x] Decidir estrategia de almacenamiento (GAP-002) ‚Üí **Volumen local, migrar a S3**
   - [x] Responder preguntas Q-001 a Q-006 ‚Üí **Todas respondidas**
   - [x] Obtener ejemplos reales de comprobantes TAD (GAP-006) ‚Üí **Formato analizado**

2. **Decisiones pendientes (elegir una opci√≥n):**
   - [ ] GAP-003: ¬øCustom SQLite o BullMQ+Redis para colas?
   - [ ] GAP-005: ¬øMarkdown o JSON para Contexto?
   - [ ] GAP-007: ¬øHandlebars, Mustache, o custom para templates?
   - [ ] GAP-004: Definir librer√≠a de generaci√≥n de PDFs

3. **Antes de iniciar desarrollo:**
   - [ ] Crear ADR (Architecture Decision Record) consolidando decisiones
   - [ ] Dise√±ar schema de base de datos completo
   - [ ] Definir estructura de carpetas del proyecto

4. **Investigaci√≥n paralela:**
   - [ ] Revisar templates de actos existentes (para crear templates iniciales)
   - [ ] Testear calidad de Vision API con PDFs escaneados reales

---

_Documento generado autom√°ticamente. Revisar y actualizar seg√∫n avance del proyecto._
